# TLS

Tyk Operator watches for certificates generated by Cert Manager, and automatically loads them into Tyk's 
Certificate Store.

Once certs are loaded into the certificate store, we can reference them in the API Definition Object

## Prerequisites

It is not necessary to use Cert Manager, however it will likely make your life easier.

First - we assume that you already have cert manager installed in your cluster:

[Cert Manager Installation](https://cert-manager.io/docs/installation/kubernetes/)

Let's install Cert Manager using CRDs

```
kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v1.0.3/cert-manager.yaml
```

You can test that Cert Manager is up and running by checking it's pods

```
$ kubectl get pods --namespace cert-manager

NAME                                       READY   STATUS    RESTARTS   AGE
cert-manager-5c6866597-zw7kh               1/1     Running   0          2m
cert-manager-cainjector-577f6d9fd7-tr77l   1/1     Running   0          2m
cert-manager-webhook-787858fcdb-nlzsq      1/1     Running   0  
```

It may also be useful for convenience to install the cert manager kubectl plugin:

[Cert Manager Kubectl Plugin](https://cert-manager.io/docs/usage/kubectl-plugin/)

## Create an Issuer

For this tutorial, we will create a self-signed issuer.

```
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned-issuer
spec:
  selfSigned: {}
```

```
$ kubectl apply -f ./tls_example/self_signed_issuer.yaml
issuer.cert-manager.io/selfsigned-issuer created
```

We will also create an ingress resource

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  namespace: default
  name: tyk-gw-ingress
  annotations:
    cert-manager.io/issuer: selfsigned-issuer
spec:
  ingressClassName: tyk
  tls:
    - secretName: tls-httpbin
      hosts:
        - myhttpbin
  rules:
    - host: myhttpbin
      http:
        paths:
          - backend:
              service:
                name: httpbin
                port:
                  number: 8000
            path: /httpbin
            pathType: Prefix
```

```
kubectl apply -f ./tls_example/httpbin_ingress.yaml
ingress.networking.k8s.io/tyk-gw-ingress created
```

If you configured everything correctly, Cert Manager will watch for new ingress resources, and generate a Certificate 
in that namespace for each entry in the `tls` section of the Ingress resource.

```
kubectl get secrets tls-httpbin   
NAME          TYPE                DATA   AGE
tls-httpbin   kubernetes.io/tls   3      30s
```

```
kubectl describe secrets tls-httpbin
Name:         tls-httpbin
Namespace:    default
Labels:       <none>
Annotations:  cert-manager.io/alt-names: myhttpbin
              cert-manager.io/certificate-name: tls-httpbin
              cert-manager.io/common-name: 
              cert-manager.io/ip-sans: 
              cert-manager.io/issuer-group: cert-manager.io
              cert-manager.io/issuer-kind: Issuer
              cert-manager.io/issuer-name: selfsigned-issuer
              cert-manager.io/uri-sans: 

Type:  kubernetes.io/tls

Data
====
ca.crt:   1017 bytes
tls.crt:  1017 bytes
tls.key:  1679 bytes
```

Tyk Operator will watch for these certs, and when it finds them, install them into Tyk's certificate store automatically.

```
kubectl cert-manager renew tls-httpbin
Manually triggered issuance of Certificate default/tls-httpbin
``` 

In the above example, we force renewed our certificate. The certificate controller inside the operator automatically 
updates Tyk's certificate store.

## ApiDefinition Resource with TLS enabled

Tyk's API Definition resource now needs to reference this secret. It can be done in one of 2 ways:

1. By referencing the K8s secret name

```
TODO: Document this
```

2. By referencing the certificate ID

```
TODO: Document this
```
